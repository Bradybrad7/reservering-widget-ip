<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéØ Real App Email Test</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 900px; 
            margin: 0 auto; 
            padding: 20px; 
            background: #f5f5f5;
        }
        .container { 
            background: white; 
            padding: 30px; 
            border-radius: 10px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 { color: #333; margin-bottom: 20px; }
        .form-group { margin: 15px 0; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, select { 
            width: 100%; 
            padding: 10px; 
            border: 1px solid #ddd; 
            border-radius: 5px; 
            font-size: 16px;
        }
        button { 
            background: #4CAF50; 
            color: white; 
            border: none; 
            padding: 15px 30px; 
            margin: 10px 5px; 
            border-radius: 5px; 
            cursor: pointer; 
            font-size: 16px;
            transition: background 0.3s;
        }
        button:hover { background: #45a049; }
        button.secondary { background: #2196F3; }
        button.secondary:hover { background: #1976D2; }
        .log { 
            background: #f8f9fa; 
            border: 1px solid #e9ecef; 
            padding: 20px; 
            margin: 20px 0; 
            border-radius: 5px; 
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 500px;
            overflow-y: auto;
        }
        .status { 
            padding: 10px 15px; 
            margin: 10px 0; 
            border-radius: 5px; 
            font-weight: bold;
        }
        .status.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .status.info { background: #cce7ff; color: #004085; border: 1px solid #b3d9ff; }
        .form-section { 
            background: #f8f9fa; 
            padding: 20px; 
            margin: 20px 0; 
            border-radius: 8px; 
            border: 1px solid #e9ecef;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéØ Real App Email Test</h1>
        
        <div class="status info">
            ‚ÑπÔ∏è <strong>Dit test de exacte email flow zoals in de echte app</strong><br>
            Deze test simuleert apiService.submitReservation() en emailService.sendPendingReservationNotification()
        </div>
        
        <div class="form-section">
            <h3>üìã Test Reservering Data</h3>
            
            <div class="form-group">
                <label for="companyName">Bedrijfsnaam:</label>
                <input type="text" id="companyName" value="Real App Test BV">
            </div>
            
            <div class="form-group">
                <label for="contactPerson">Contactpersoon:</label>
                <input type="text" id="contactPerson" value="App Test Gebruiker">
            </div>
            
            <div class="form-group">
                <label for="email">Email (ontvanger):</label>
                <input type="email" id="email" value="info@inspiration-point.nl">
            </div>
            
            <div class="form-group">
                <label for="numberOfPersons">Aantal personen:</label>
                <input type="number" id="numberOfPersons" value="4" min="1" max="20">
            </div>
            
            <div class="form-group">
                <label for="arrangement">Arrangement:</label>
                <select id="arrangement">
                    <option value="BWF">BWF - Brood, Water & Frisdrank</option>
                    <option value="BWFM">BWFM - Brood, Water, Frisdrank + Maaltijd</option>
                </select>
            </div>
        </div>
        
        <button onclick="testRealAppBooking()">
            üéØ Test Real App Booking Flow
        </button>
        
        <button onclick="checkEnvironment()" class="secondary">
            üîß Check Environment
        </button>
        
        <button onclick="clearLog()">
            üóëÔ∏è Clear Log
        </button>
        
        <div id="status"></div>
        <div id="log" class="log">Real app email test geladen...\nWachtend op test...\n</div>
    </div>

    <script type="module">
        const log = document.getElementById('log');
        const status = document.getElementById('status');
        
        function addLog(message) {
            log.textContent += new Date().toLocaleTimeString() + ' - ' + message + '\n';
            log.scrollTop = log.scrollHeight;
        }
        
        function setStatus(message, type = 'info') {
            status.innerHTML = `<div class="status ${type}">${message}</div>`;
        }
        
        window.clearLog = function() {
            log.textContent = 'Log cleared...\n';
            status.innerHTML = '';
        };
        
        window.checkEnvironment = function() {
            addLog('üîß Checking environment variables...');
            
            const env = {
                DEV: import.meta.env.DEV,
                FORCE_EMAIL: import.meta.env.VITE_FORCE_EMAIL_IN_DEV,
                EMAIL_FROM: import.meta.env.VITE_EMAIL_FROM,
                EMAIL_FROM_NAME: import.meta.env.VITE_EMAIL_FROM_NAME
            };
            
            addLog('Environment: ' + JSON.stringify(env, null, 2));
            
            if (env.FORCE_EMAIL === 'true') {
                setStatus('‚úÖ Environment OK - Email forcing is enabled', 'success');
            } else {
                setStatus('‚ö†Ô∏è Warning - VITE_FORCE_EMAIL_IN_DEV is not "true": ' + env.FORCE_EMAIL, 'error');
            }
        };
        
        window.testRealAppBooking = async function() {
            addLog('üéØ Starting REAL APP booking flow test...');
            setStatus('üîÑ Simulating exact app booking flow...', 'info');
            
            try {
                // Get form data
                const formData = {
                    companyName: document.getElementById('companyName').value,
                    contactPerson: document.getElementById('contactPerson').value,
                    email: document.getElementById('email').value,
                    numberOfPersons: parseInt(document.getElementById('numberOfPersons').value),
                    arrangement: document.getElementById('arrangement').value,
                    firstName: 'Real App',
                    lastName: 'Test',
                    phone: '+31612345678',
                    phoneCountryCode: '+31',
                    salutation: 'Dhr.',
                    comments: 'Real app booking flow test'
                };
                
                addLog('üìã Form data: ' + JSON.stringify(formData, null, 2));
                
                // Simulate the EXACT reservation data structure from apiService
                const reservationData = {
                    id: 'real-app-test-' + Date.now(),
                    eventId: 'test-event-id',
                    eventDate: new Date('2025-12-15'),
                    ...formData,
                    status: 'pending',
                    totalPrice: formData.numberOfPersons * 44.75, // BWF price
                    createdAt: new Date(),
                    paymentStatus: 'pending',
                    source: 'widget'
                };
                
                const eventData = {
                    id: 'test-event-id',
                    date: new Date('2025-12-15'),
                    startsAt: '19:30',
                    endsAt: '22:30',
                    doorsOpen: '19:00',
                    type: 'REGULAR',
                    showId: 'show-1',
                    capacity: 100,
                    isActive: true
                };
                
                addLog('üìß Environment check before email call...');
                const env = {
                    DEV: import.meta.env.DEV,
                    FORCE_EMAIL: import.meta.env.VITE_FORCE_EMAIL_IN_DEV,
                    EMAIL_FROM: import.meta.env.VITE_EMAIL_FROM
                };
                addLog('Environment: ' + JSON.stringify(env, null, 2));
                
                // Test the EXACT email service flow
                addLog('üìß Testing sendPendingReservationNotification flow...');
                
                // STEP 1: Generate pending reservation email (customer)
                const eventDate = eventData.date.toLocaleDateString('nl-NL', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
                
                const customerEmailData = {
                    to: [reservationData.email],
                    subject: `‚è≥ Reservering ontvangen en in behandeling - ${reservationData.companyName} (${eventDate})`,
                    html: `
                        <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
                            <div style="background: linear-gradient(135deg, #FFA500 0%, #FF8C00 100%); color: white; padding: 30px; text-align: center;">
                                <h1>üìã Reservering Ontvangen</h1>
                                <p>Inspiration Point</p>
                            </div>
                            <div style="background: white; padding: 30px; border: 1px solid #e0e0e0;">
                                <p>Beste ${reservationData.contactPerson},</p>
                                <p>Bedankt voor uw reservering! Wij hebben uw aanvraag ontvangen en nemen deze in behandeling.</p>
                                <div style="background: #fff8e7; padding: 20px; margin: 20px 0; border-radius: 8px; border-left: 4px solid #FFA500;">
                                    <h3>üìÖ Reserveringsgegevens</h3>
                                    <p><strong>Reserveringsnummer:</strong> ${reservationData.id}</p>
                                    <p><strong>Bedrijf:</strong> ${reservationData.companyName}</p>
                                    <p><strong>Datum:</strong> ${eventDate}</p>
                                    <p><strong>Tijd:</strong> ${eventData.startsAt} - ${eventData.endsAt}</p>
                                    <p><strong>Aantal personen:</strong> ${reservationData.numberOfPersons}</p>
                                    <p><strong>Arrangement:</strong> ${reservationData.arrangement}</p>
                                    <p><strong>Status:</strong> <span style="background: #FFA500; color: white; padding: 5px 10px; border-radius: 3px;">IN BEHANDELING</span></p>
                                </div>
                                <p><strong>üéØ Dit is een REAL APP FLOW TEST</strong></p>
                                <p>Deze email simuleert exact wat klanten ontvangen bij een echte boeking.</p>
                            </div>
                        </div>
                    `,
                    text: `Reservering Ontvangen - Inspiration Point\n\nReserveringsnummer: ${reservationData.id}\nBedrijf: ${reservationData.companyName}\nDatum: ${eventDate}\nPersonen: ${reservationData.numberOfPersons}\nStatus: IN BEHANDELING\n\nDit is een Real App Flow Test.`,
                    from: 'info@inspiration-point.nl',
                    fromName: 'Inspiration Point'
                };
                
                // STEP 2: Generate admin notification email  
                const adminEmailData = {
                    to: ['info@inspiration-point.nl'],
                    subject: `üö® NIEUWE RESERVERING ${reservationData.id} - ${reservationData.companyName} (${eventDate})`,
                    html: `
                        <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
                            <div style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); color: white; padding: 30px; text-align: center;">
                                <h1>üö® NIEUWE RESERVERING</h1>
                                <p style="margin: 0;">Real App Flow Test</p>
                            </div>
                            <div style="background: white; padding: 30px; border: 1px solid #e0e0e0;">
                                <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; margin-bottom: 20px; border-radius: 5px;">
                                    <h3 style="margin-top: 0; color: #856404;">üéØ REAL APP FLOW TEST</h3>
                                    <p style="margin-bottom: 0;">Deze admin email simuleert exact wat jullie ontvangen bij elke nieuwe boeking.</p>
                                </div>
                                <h3>üìã RESERVERINGSGEGEVENS</h3>
                                <div style="background: #f8f9fa; padding: 15px; margin: 15px 0; border-radius: 5px;">
                                    <p><strong>Nummer:</strong> ${reservationData.id}</p>
                                    <p><strong>Status:</strong> PENDING (wacht op goedkeuring)</p>
                                    <p><strong>Bedrijf:</strong> ${reservationData.companyName}</p>
                                    <p><strong>Contact:</strong> ${reservationData.contactPerson}</p>
                                    <p><strong>Email:</strong> ${reservationData.email}</p>
                                    <p><strong>Telefoon:</strong> ${reservationData.phone}</p>
                                    <p><strong>Datum:</strong> ${eventDate} om ${eventData.startsAt}</p>
                                    <p><strong>Personen:</strong> ${reservationData.numberOfPersons}</p>
                                    <p><strong>Arrangement:</strong> ${reservationData.arrangement}</p>
                                    <p><strong>Totaal:</strong> ‚Ç¨${reservationData.totalPrice.toFixed(2)}</p>
                                </div>
                                <div style="background: #d4edda; border: 1px solid #c3e6cb; padding: 15px; margin: 20px 0; border-radius: 5px;">
                                    <h4 style="margin-top: 0; color: #155724;">‚úÖ ACTIES TE ONDERNEMEN</h4>
                                    <ol>
                                        <li>Controleer beschikbaarheid voor ${eventDate}</li>
                                        <li>Verstuur betalingsinformatie naar klant</li>
                                        <li>Bevestig reservering na ontvangst betaling</li>
                                    </ol>
                                </div>
                            </div>
                        </div>
                    `,
                    text: `NIEUWE RESERVERING - Real App Test\n\nNummer: ${reservationData.id}\nBedrijf: ${reservationData.companyName}\nContact: ${reservationData.contactPerson}\nEmail: ${reservationData.email}\nDatum: ${eventDate}\nPersonen: ${reservationData.numberOfPersons}\nTotaal: ‚Ç¨${reservationData.totalPrice.toFixed(2)}`,
                    from: 'info@inspiration-point.nl',
                    fromName: 'Inspiration Point'
                };
                
                // STEP 3: Send both emails (exact Firebase Function calls)
                addLog('üìß Sending customer email (like emailService does)...');
                const customerResponse = await fetch('https://europe-west1-dinner-theater-booking.cloudfunctions.net/sendSmtpEmail', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(customerEmailData)
                });
                const customerResult = await customerResponse.json();
                addLog('üì® Customer email result: ' + JSON.stringify(customerResult, null, 2));
                
                addLog('üìß Sending admin email (like emailService does)...');
                const adminResponse = await fetch('https://europe-west1-dinner-theater-booking.cloudfunctions.net/sendSmtpEmail', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(adminEmailData)
                });
                const adminResult = await adminResponse.json();
                addLog('üì® Admin email result: ' + JSON.stringify(adminResult, null, 2));
                
                // STEP 4: Summary
                addLog('üìä FINAL RESULTS:');
                addLog('   Customer notification: ' + (customerResult.success ? '‚úÖ SUCCESS' : '‚ùå FAILED'));
                addLog('   Admin notification: ' + (adminResult.success ? '‚úÖ SUCCESS' : '‚ùå FAILED'));
                
                if (customerResult.success && adminResult.success) {
                    addLog('üéâ COMPLETE SUCCESS! Both emails sent successfully');
                    setStatus('üéâ Perfect! Alle emails verzonden - Check info@inspiration-point.nl inbox voor beide emails', 'success');
                    addLog('üì¨ Check inbox voor:');
                    addLog('   1. ‚è≥ Klant bevestiging (reservering ontvangen)');
                    addLog('   2. üö® Admin notificatie (nieuwe reservering)');
                } else {
                    setStatus('‚ö†Ô∏è Partial success - check log for details', 'error');
                }
                
                addLog('üéØ REAL APP FLOW TEST COMPLETED');
                
            } catch (error) {
                addLog('üî• ERROR during real app test: ' + error.message);
                addLog('üî• Stack: ' + error.stack);
                setStatus('üî• Error: ' + error.message, 'error');
            }
        };
        
        // Initial environment check
        window.checkEnvironment();
        
        addLog('‚úÖ Real app email test system loaded');
        addLog('üí° This simulates the EXACT email flow as the real app');
        addLog('üéØ Click "Test Real App Booking Flow" to begin');
    </script>
</body>
</html>