<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cleanup Duplicate Reservations</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      max-width: 1000px;
      margin: 0 auto;
      padding: 20px;
      background: #0a0e27;
      color: #e0e6ed;
    }
    .section {
      background: #1a1f3a;
      border: 1px solid #2d3461;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
    }
    button {
      background: #4a90e2;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 5px;
      cursor: pointer;
      margin: 5px;
      font-size: 14px;
      font-weight: 600;
    }
    button:hover {
      background: #357abd;
    }
    button.danger {
      background: #f44336;
    }
    button.danger:hover {
      background: #d32f2f;
    }
    button:disabled {
      background: #666;
      cursor: not-allowed;
    }
    .success {
      color: #4caf50;
      font-weight: bold;
    }
    .error {
      color: #f44336;
      font-weight: bold;
    }
    .warning {
      color: #ff9800;
      font-weight: bold;
    }
    .info {
      color: #2196f3;
    }
    #results {
      background: #0f1329;
      border: 1px solid #2d3461;
      border-radius: 5px;
      padding: 15px;
      margin-top: 20px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      max-height: 400px;
      overflow-y: auto;
    }
    h1 {
      color: #4a90e2;
      border-bottom: 2px solid #2d3461;
      padding-bottom: 10px;
    }
    h2 {
      color: #7ba7d9;
      margin-top: 0;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      padding: 8px;
      text-align: left;
      border-bottom: 1px solid #2d3461;
    }
    th {
      background: #0f1329;
      color: #7ba7d9;
    }
    .badge {
      padding: 4px 8px;
      border-radius: 3px;
      font-size: 11px;
      font-weight: bold;
    }
    .badge-old {
      background: #f44336;
      color: white;
    }
    .badge-new {
      background: #4caf50;
      color: white;
    }
  </style>
</head>
<body>
  <h1>üßπ Cleanup Duplicate Reservations</h1>
  
  <div class="section">
    <h2>‚ö†Ô∏è Problem Detected</h2>
    <p>Your system has reservations with <strong>timestamp-based IDs</strong> (e.g., <code>res-1761834160763</code>) that don't exist in Firestore.</p>
    <p>Firestore uses <strong>counter-based IDs</strong> (e.g., <code>res-1</code>, <code>res-2</code>).</p>
    <p>This tool will help you identify and clean up these duplicates.</p>
  </div>

  <div class="section">
    <h2>1. Scan for Duplicates</h2>
    <button onclick="scanDuplicates()">üîç Scan All Reservations</button>
    <div id="scan-results"></div>
  </div>

  <div class="section">
    <h2>2. Preview Cleanup</h2>
    <button onclick="previewCleanup()">üëÅÔ∏è Preview What Will Be Removed</button>
    <div id="preview-results"></div>
  </div>

  <div class="section">
    <h2>3. Clean Up</h2>
    <p class="warning">‚ö†Ô∏è This will reload the page to clear the Zustand store and fetch fresh data from Firestore.</p>
    <button class="danger" onclick="cleanupDuplicates()">üßπ Clean Up & Reload</button>
    <div id="cleanup-results"></div>
  </div>

  <div id="results">
    <div class="info">üîç Click "Scan All Reservations" to start...</div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { 
      getFirestore, 
      collection, 
      getDocs, 
      deleteDoc,
      doc
    } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyCaH8VZJZhuJtMKSjC44VX6QWmPfAdlJ80",
      authDomain: "dinner-theater-booking.firebaseapp.com",
      projectId: "dinner-theater-booking",
      storageBucket: "dinner-theater-booking.firebasestorage.app",
      messagingSenderId: "802367293541",
      appId: "1:802367293541:web:5d2928c0cb6fa2c8bbde8c",
      measurementId: "G-83WTWDTX7V"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const resultsDiv = document.getElementById('results');
    let allReservations = [];
    let timestampBasedIds = [];
    let counterBasedIds = [];

    function log(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const colors = {
        success: '#4caf50',
        error: '#f44336',
        warning: '#ff9800',
        info: '#2196f3'
      };
      
      const entry = document.createElement('div');
      entry.style.color = colors[type];
      entry.style.marginBottom = '5px';
      entry.innerHTML = `[${timestamp}] ${message}`;
      resultsDiv.appendChild(entry);
      resultsDiv.scrollTop = resultsDiv.scrollHeight;
    }

    window.scanDuplicates = async function() {
      log('üîç Scanning all reservations in Firestore...', 'info');
      const scanResults = document.getElementById('scan-results');
      scanResults.innerHTML = '<p>Loading...</p>';
      
      try {
        const snapshot = await getDocs(collection(db, 'reservations'));
        allReservations = snapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));
        
        // Separate by ID pattern
        timestampBasedIds = allReservations.filter(r => /res-\d{13,}/.test(r.id));
        counterBasedIds = allReservations.filter(r => /res-\d{1,6}$/.test(r.id));
        
        log(`‚úÖ Found ${allReservations.length} total reservations`, 'success');
        log(`   ‚Ä¢ ${counterBasedIds.length} with counter-based IDs (correct)`, 'success');
        log(`   ‚Ä¢ ${timestampBasedIds.length} with timestamp-based IDs (old/invalid)`, 'error');
        
        // Display table
        let table = '<table><tr><th>ID</th><th>Contact</th><th>Event</th><th>Status</th><th>Type</th></tr>';
        
        allReservations.forEach(r => {
          const isOld = /res-\d{13,}/.test(r.id);
          const badgeClass = isOld ? 'badge-old' : 'badge-new';
          const badgeText = isOld ? 'OLD' : 'OK';
          
          table += `
            <tr style="${isOld ? 'background: rgba(244, 67, 54, 0.1);' : ''}">
              <td><code>${r.id}</code></td>
              <td>${r.contactPerson || 'N/A'}</td>
              <td>${r.eventId || 'N/A'}</td>
              <td>${r.status || 'N/A'}</td>
              <td><span class="badge ${badgeClass}">${badgeText}</span></td>
            </tr>
          `;
        });
        
        table += '</table>';
        scanResults.innerHTML = table;
        
      } catch (error) {
        log(`‚ùå Scan failed: ${error.message}`, 'error');
        scanResults.innerHTML = `<p class="error">Error: ${error.message}</p>`;
      }
    };

    window.previewCleanup = async function() {
      if (allReservations.length === 0) {
        log('‚ö†Ô∏è Please run scan first!', 'warning');
        return;
      }
      
      const previewResults = document.getElementById('preview-results');
      
      if (timestampBasedIds.length === 0) {
        previewResults.innerHTML = '<p class="success">‚úÖ No cleanup needed! All reservations have correct IDs.</p>';
        log('‚úÖ No cleanup needed!', 'success');
        return;
      }
      
      log(`üìã Preview: ${timestampBasedIds.length} reservations will be cleaned up`, 'warning');
      
      let html = '<h3 class="warning">‚ö†Ô∏è These reservations will be removed from Firestore:</h3>';
      html += '<p><small>(Don\'t worry - the page will reload to fetch correct data)</small></p>';
      html += '<ul>';
      
      timestampBasedIds.forEach(r => {
        html += `<li><code>${r.id}</code> - ${r.contactPerson || 'N/A'} (${r.status})</li>`;
      });
      
      html += '</ul>';
      html += `<p class="info">After cleanup, you'll have ${counterBasedIds.length} valid reservations.</p>`;
      
      previewResults.innerHTML = html;
    };

    window.cleanupDuplicates = async function() {
      if (allReservations.length === 0) {
        alert('Please run scan first!');
        return;
      }
      
      if (timestampBasedIds.length === 0) {
        alert('No cleanup needed!');
        return;
      }
      
      if (!confirm(`‚ö†Ô∏è WARNING!\n\nThis will delete ${timestampBasedIds.length} reservations with old IDs from Firestore.\n\nThe page will then reload to fetch fresh data.\n\nContinue?`)) {
        return;
      }
      
      const cleanupResults = document.getElementById('cleanup-results');
      cleanupResults.innerHTML = '<p class="warning">Cleaning up...</p>';
      
      log('üßπ Starting cleanup...', 'warning');
      
      let deleted = 0;
      let failed = 0;
      
      for (const res of timestampBasedIds) {
        try {
          await deleteDoc(doc(db, 'reservations', res.id));
          log(`‚úÖ Deleted ${res.id}`, 'success');
          deleted++;
        } catch (error) {
          log(`‚ùå Failed to delete ${res.id}: ${error.message}`, 'error');
          failed++;
        }
      }
      
      log(`‚úÖ Cleanup complete! Deleted: ${deleted}, Failed: ${failed}`, 'success');
      cleanupResults.innerHTML = `<p class="success">‚úÖ Deleted ${deleted} reservations. Reloading...</p>`;
      
      // Wait a bit then reload
      setTimeout(() => {
        log('üîÑ Reloading page...', 'info');
        window.location.reload();
      }, 2000);
    };

    // Auto-scan on load
    window.addEventListener('load', () => {
      setTimeout(() => {
        scanDuplicates();
      }, 500);
    });
  </script>
</body>
</html>
